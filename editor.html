<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ì¹˜ í…ìŠ¤íŠ¸ ì—ë””í„° - My Blog</title>
    <!-- Icon -->
    <link rel="shortcut icon" href="./assets/Vector.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/editor.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google API Libraries -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Icon meta js -->
    <script src="js/head-meta.js"></script>
    <!-- Auth js -->
    <script src="js/auth.js"></script>

    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/0470599ade.js" crossorigin="anonymous"></script>
    
    <style>
        .backBtn:hover {
            background-color: #f5f5f5 !important;
        }
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .simple-editor.drag-over {
            background-color: rgba(74, 185, 255, 0.1) !important;
            border: 2px dashed #4ab9ff !important;
            transition: all 0.2s ease;
        }
        
        .simple-editor::after {
            content: '';
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(74, 185, 255, 0.9);
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            pointer-events: none;
            z-index: 1000;
        }
        
        .simple-editor.drag-over::after {
            content: 'ğŸ“ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”';
            display: block;
        }
        
        /* ì—…ë¡œë“œëœ ë¯¸ë””ì–´ ìŠ¤íƒ€ì¼ */
        .simple-editor img {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .simple-editor img:hover {
            transform: scale(1.02);
        }
        
        .simple-editor iframe {
            border-radius: 8px;
        }
    </style>
</head>
<body class="editor">
    <!-- ì¸ì¦ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í˜ì´ì§€ ë¡œë“œì‹œ ì¸ì¦ í™•ì¸
        if (!Auth.isLoggedIn()) {
            Auth.redirectToLogin();
        }
    </script>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-actions">
                <div class="header-left">
                    <button onclick="history.back()" class="backBtn" style="background: none; border: none; color: #333; font-size: 1rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 4px; transition: background-color 0.2s ease;">
                        â† 
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Toolbar Section -->
    <div class="toolbar-section">
        <div class="container">
            <div class="header-toolbar">
                <div class="simple-toolbar">
                    
                    <select onchange="format('formatBlock', this.value); this.value=''; setTimeout(() => { if(window.editor) { window.editor.editor.focus(); window.editor.moveCaretToEnd(); } }, 10);">
                        <option value="">ë‹¨ë½ ìŠ¤íƒ€ì¼</option>
                        <option value="h1">ì œëª© 1</option>
                        <option value="h2">ì œëª© 2</option>
                        <option value="h3">ì œëª© 3</option>
                        <option value="p">ë³¸ë¬¸</option>
                    </select>
                    
                    <button onclick="format('bold'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="êµµê²Œ (Ctrl+B)"><b>B</b></button>
                    <button onclick="format('italic'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ê¸°ìš¸ì„ (Ctrl+I)"><i>I</i></button>
                    <button onclick="format('underline'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ë°‘ì¤„ (Ctrl+U)"><u>U</u></button>
                    <button onclick="format('strikeThrough'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ì·¨ì†Œì„ "><s>S</s></button>

                    <div class="color-button-wrapper">
                        <button class="color-button text-color-btn" onclick="document.getElementById('textColor').click()" title="ê¸€ì ìƒ‰">
                            <span class="color-letter">A</span>
                            <span class="color-bar" id="textColorBar"></span>
                            <input type="color" id="textColor" onchange="changeTextColor(this.value)" style="display: none;">
                        </button>
                    </div>
                    
                    <div class="highlight-wrapper">
                        <button class="highlight-btn" onclick="toggleHighlight()" title="í•˜ì´ë¼ì´íŠ¸">
                            <div class="highlight-color-display" id="highlightColorDisplay"></div>
                        </button>
                        <div class="highlight-colors" id="highlightColors" style="display: none;">
                            <button class="highlight-color" style="background-color: #ffff6b;" onclick="applyHighlight('#ffff6b')" title="ë…¸ë€ìƒ‰"></button>
                            <button class="highlight-color" style="background-color: #93ff6b;" onclick="applyHighlight('#93ff6b')" title="ì—°ë‘ìƒ‰"></button>
                            <button class="highlight-color" style="background-color: #b3fffa;" onclick="applyHighlight('#b3fffa')" title="í•˜ëŠ˜ìƒ‰"></button>
                            <button class="highlight-color" style="background-color: #b3b5ff;" onclick="applyHighlight('#b3b5ff')" title="ë³´ë¼ìƒ‰"></button>
                            <button class="highlight-color" style="background-color: #fbc7ff;" onclick="applyHighlight('#fbc7ff')" title="ë¶„í™ìƒ‰"></button>
                            <button class="highlight-color" style="background-color: #ffc2c2;" onclick="applyHighlight('#ffc2c2')" title="ë¹¨ê°„ìƒ‰"></button>
                        </div>
                    </div>

                    <button onclick="format('insertUnorderedList'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ê¸€ë¨¸ë¦¬ ê¸°í˜¸">â€¢</button>
                    <button onclick="format('insertOrderedList'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ë²ˆí˜¸ ë§¤ê¸°ê¸°">1.</button>
                                        
                    <button onclick="format('justifyLeft'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ì™¼ìª½ ì •ë ¬"><i class="fa-solid fa-align-left"></i></button>
                    <button onclick="format('justifyCenter'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ê°€ìš´ë° ì •ë ¬"><i class="fa-solid fa-align-center"></i></button>
                    <button onclick="format('justifyRight'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ì˜¤ë¥¸ìª½ ì •ë ¬"><i class="fa-solid fa-align-right"></i></button>
                    <button onclick="format('justifyFull'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ì–‘ìª½ ì •ë ¬"><i class="fa-solid fa-align-justify"></i></button>
                                        
                    <button id="linkToggleBtn" onclick="toggleLink(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ë§í¬">ğŸ”—</button>
                    
                    <button id="imageUploadBtn" onclick="openImageUpload(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ"><i class="fa-solid fa-image"></i></button>
                    <button id="videoUploadBtn" onclick="openVideoUpload(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ë¹„ë””ì˜¤ ì—…ë¡œë“œ"><i class="fa-solid fa-video"></i></button>
                                        
                    <button onclick="format('undo'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ì‹¤í–‰ ì·¨ì†Œ">â†¶</button>
                    <button onclick="format('redo'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ë‹¤ì‹œ ì‹¤í–‰">â†·</button>
                                        
                    <button id="codeViewToggle" onclick="toggleCodeView(); setTimeout(() => { if(window.editor && !window.editor.isCodeView) { window.editor.editor.focus(); } }, 10);" title="HTML ì½”ë“œ ë³´ê¸°">HTML</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="editor-container">
                <!-- Editor Header -->
                <div class="editor-header">
                </div>

                <!-- Post Metadata -->
                <div class="post-metadata">
                    <input type="text" id="postTitle" placeholder="Untitled..." class="title-input">
                </div>
                
                <!-- Simple Editor Container -->
                <div class="simple-editor-wrapper">
                    <div class="simple-editor" contenteditable="true" id="editor">
                        <div>ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <span id="progressText">ì—…ë¡œë“œ ì¤‘...</span>
                </div>
                
                <!-- Editor Actions -->
            </div>
        </div>
    </main>
    
    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container">
        <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="tags-container">
            <div class="tags-wrapper" id="tagsWrapper">
                <!-- íƒœê·¸ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                <input type="text" id="tagInput" class="tag-input" placeholder="#íƒœê·¸ì…ë ¥">
            </div>
        </div>
        <div class="container">
            <div class="footer-actions">
                <div class="footer-left">
                    <select id="statusSelect" class="status-select">
                        <option value="published" selected>ë°œí–‰ë¨</option>
                        <option value="private">ë¹„ê³µê°œ</option>
                    </select>
                </div>
                <div class="footer-center">
                    <div class="datetime-display" id="realtimeClock"></div>
                </div>
                <div class="footer-right">
                    <button type="button" class="btn btn-success" id="saveBtn">ì €ì¥</button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/drive-uploader.js"></script>
    <script src="js/upload.js"></script>
    <script src="js/editor.js"></script>
    
    <script>
        // ì‹¤ì‹œê°„ ì‹œê³„ ê¸°ëŠ¥
        function updateClock() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timeString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            document.getElementById('realtimeClock').textContent = timeString;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œê³„ ì‹œì‘
        document.addEventListener('DOMContentLoaded', function() {
            updateClock(); // ì¦‰ì‹œ í‘œì‹œ
            setInterval(updateClock, 1000); // ë§¤ì´ˆ ì—…ë°ì´íŠ¸
        });
    </script>
    
    <!-- Tags Input Script -->
    <script>
        // Tags functionality
        class TagsInput {
            constructor() {
                this.tags = [];
                this.tagInput = document.getElementById('tagInput');
                this.tagsWrapper = document.getElementById('tagsWrapper');
                
                this.init();
            }
            
            init() {
                this.tagInput.addEventListener('keydown', (e) => {
                    if (e.key === ',' || e.key === 'Enter') {
                        e.preventDefault();
                        this.addTag();
                    } else if (e.key === 'Backspace' && this.tagInput.value === '') {
                        this.removeLastTag();
                    }
                });
                
                this.tagInput.addEventListener('blur', () => {
                    if (this.tagInput.value.trim()) {
                        this.addTag();
                    }
                });
            }
            
            addTag() {
                const value = this.tagInput.value.trim();
                if (value && !this.tags.includes(value)) {
                    this.tags.push(value);
                    this.renderTags();
                    this.tagInput.value = '';
                }
            }
            
            removeTag(tagToRemove) {
                this.tags = this.tags.filter(tag => tag !== tagToRemove);
                this.renderTags();
            }
            
            removeLastTag() {
                if (this.tags.length > 0) {
                    this.tags.pop();
                    this.renderTags();
                }
            }
            
            renderTags() {
                // ê¸°ì¡´ íƒœê·¸ë“¤ ì œê±° (input ì œì™¸)
                const existingTags = this.tagsWrapper.querySelectorAll('.tag');
                existingTags.forEach(tag => tag.remove());
                
                // ìƒˆ íƒœê·¸ë“¤ ì¶”ê°€
                this.tags.forEach(tagText => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        <span>${tagText}</span>
                        <button type="button" class="tag-remove" onclick="tagsInput.removeTag('${tagText}')">&times;</button>
                    `;
                    
                    // input ì•ì— ì‚½ì…
                    this.tagsWrapper.insertBefore(tagElement, this.tagInput);
                });
            }
            
            getTags() {
                return this.tags;
            }
            
            setTags(tags) {
                this.tags = tags || [];
                this.renderTags();
            }
            
            getTagsString() {
                return this.tags.join(', ');
            }
        }
        
        // ìŠ¤ë§ˆíŠ¸ ë§í¬ í† ê¸€ í•¨ìˆ˜
        function toggleLink() {
            const selection = window.getSelection();
            const linkBtn = document.getElementById('linkToggleBtn');
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let parentElement = range.commonAncestorContainer;
                
                // í…ìŠ¤íŠ¸ ë…¸ë“œì¸ ê²½ìš° ë¶€ëª¨ ìš”ì†Œ ì°¾ê¸°
                if (parentElement.nodeType === Node.TEXT_NODE) {
                    parentElement = parentElement.parentElement;
                }
                
                // í˜„ì¬ ì„ íƒ ì˜ì—­ì´ ë§í¬ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
                let linkElement = null;
                let currentElement = parentElement;
                
                // ë¶€ëª¨ë¥¼ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ë©° ë§í¬ ìš”ì†Œ ì°¾ê¸°
                while (currentElement && currentElement !== document.body) {
                    if (currentElement.tagName === 'A') {
                        linkElement = currentElement;
                        break;
                    }
                    currentElement = currentElement.parentElement;
                }
                
                if (linkElement) {
                    // ë§í¬ê°€ ìˆìœ¼ë©´ ì œê±°
                    format('unlink');
                    linkBtn.textContent = 'ğŸ”—';
                    linkBtn.title = 'ë§í¬ ì‚½ì…';
                    linkBtn.style.color = '';
                } else {
                    // ë§í¬ê°€ ì—†ìœ¼ë©´ ì‚½ì…
                    if (selection.toString().trim()) {
                        // í…ìŠ¤íŠ¸ê°€ ì„ íƒëœ ê²½ìš°
                        insertLink();
                        linkBtn.textContent = 'ğŸ”—';
                        linkBtn.title = 'ë§í¬ ì œê±°';
                        linkBtn.style.color = '#007bff';
                    } else {
                        // í…ìŠ¤íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°
                        alert('ë§í¬ë¥¼ ì¶”ê°€í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                    }
                }
            } else {
                alert('ë§í¬ë¥¼ ì¶”ê°€í•  í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateLinkButtonState();
        }
        
        // ë§í¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateLinkButtonState() {
            const linkBtn = document.getElementById('linkToggleBtn');
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let parentElement = range.commonAncestorContainer;
                
                if (parentElement.nodeType === Node.TEXT_NODE) {
                    parentElement = parentElement.parentElement;
                }
                
                // ë§í¬ ìš”ì†Œ ì°¾ê¸°
                let currentElement = parentElement;
                let hasLink = false;
                
                while (currentElement && currentElement !== document.body) {
                    if (currentElement.tagName === 'A') {
                        hasLink = true;
                        break;
                    }
                    currentElement = currentElement.parentElement;
                }
                
                if (hasLink) {
                    linkBtn.style.backgroundColor = '#007bff';
                    linkBtn.style.color = 'white';
                    linkBtn.title = 'ë§í¬ ì œê±°';
                } else {
                    linkBtn.style.backgroundColor = '';
                    linkBtn.style.color = '';
                    linkBtn.title = 'ë§í¬ ì‚½ì…';
                }
            }
        }
        
        // ì—ë””í„°ì—ì„œ ì„ íƒ ë³€ê²½ ì‹œ ë§í¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.addEventListener('selectionchange', () => {
            if (document.getElementById('linkToggleBtn')) {
                updateLinkButtonState();
            }
        });

        // Initialize tags input when DOM is ready
        let tagsInput;
        document.addEventListener('DOMContentLoaded', () => {
            tagsInput = new TagsInput();
            window.tagsInput = tagsInput; // ì „ì—­ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡
            
            // Initialize uploaded files list for new post
            resetUploadedFiles();
        });

        // Google Drive Upload Functions
        function openImageUpload() {
            // ì‚¬ìš©ì í´ë¦­ ì•¡ì…˜ì„ ë°”ë¡œ íŒŒì¼ ì„ íƒì— ì‚¬ìš©
            document.getElementById('imageFileInput').click();
        }

        function openVideoUpload() {
            // ì‚¬ìš©ì í´ë¦­ ì•¡ì…˜ì„ ë°”ë¡œ íŒŒì¼ ì„ íƒì— ì‚¬ìš©
            document.getElementById('videoFileInput').click();
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì „ ì¸ì¦ í™•ì¸ ë° ì¤€ë¹„
        async function ensureAuthBeforeUpload() {
            try {
                // DriveUploader ì¸ìŠ¤í„´ìŠ¤ í™•ì¸ ë° ì´ˆê¸°í™”
                if (!window.driveUploader) {
                    console.log('ğŸš€ Initializing DriveUploader...');
                    showToast('Google Drive ì¤€ë¹„ ì¤‘...', 'info');
                    await initializeDriveUploader();
                }
                
                // ì´ë¯¸ ì¸ì¦ëœ ê²½ìš° ë°”ë¡œ ë¦¬í„´
                if (window.driveUploader.isAuthenticated) {
                    console.log('âœ… Already authenticated, ready for upload');
                    return;
                }
                
                // ì¸ì¦ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ê³  ì¸ì¦ ì§„í–‰
                showToast('Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”...', 'info');
                console.log('ğŸ”„ Authentication required, attempting auth...');
                
                const authResult = await window.driveUploader.authenticate(false);
                
                if (authResult && authResult.success) {
                    console.log('âœ… Authentication successful');
                    showToast('ì¸ì¦ ì™„ë£Œ! ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'success');
                } else {
                    throw new Error('Google Drive ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('âŒ Auth failed:', error);
                showToast(`ì¸ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
                throw error;
            }
        }



        // ê´€ë¦¬ì ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        function checkAdminAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');
            
            if (!token || !expires || Date.now() > parseInt(expires)) {
                // ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•¨
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // DriveUploader ì´ˆê¸°í™” ë° ìë™ ë¡œê·¸ì¸ í™•ì¸
        async function initializeDriveUploader() {
            console.log('ğŸš€ Initializing DriveUploader...');
            
            // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
            if (!checkAdminAuth()) {
                return;
            }
            
            window.driveUploader = new DriveUploader();
            
            // ì´ˆê¸°í™” ì™„ë£Œ ëŒ€ê¸°
            await window.driveUploader.waitForInitialization();
            
            // ìë™ ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸ (UI ì—…ë°ì´íŠ¸ ì—†ì´)
            setTimeout(() => {
                if (window.driveUploader.isAuthenticated) {
                    console.log('âœ… Auto-login successful - ready for file uploads');
                } else {
                    console.log('ğŸ“­ Auto-login not available - will authenticate on file upload');
                }
            }, 3000);
        }
        


        async function handleFileUpload(files, fileType) {
            if (!files || files.length === 0) return;

            const file = files[0];
            let placeholderId = null;
            
            try {
                console.log('ğŸ“¤ Starting file upload:', file.name, fileType);
                
                // íŒŒì¼ ì„ íƒ í›„ ì¸ì¦ í™•ì¸ ë° í•„ìš”ì‹œ ì¸ì¦ ì§„í–‰
                await ensureAuthBeforeUpload();
                
                if (!window.driveUploader || !window.driveUploader.isAuthenticated) {
                    console.error('âŒ Authentication failed');
                    showToast('Google Drive ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // ì—…ë¡œë“œ ì‹œì‘ - ë¡œë”© ìŠ¤í”¼ë„ˆ ì‚½ì…
                placeholderId = insertUploadPlaceholder(file.name, fileType);
                showToast('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', 'info');
                
                // íŒŒì¼ ì—…ë¡œë“œ ì‹¤í–‰
                const publicUrl = await window.driveUploader.uploadFile(file, Date.now(), fileType);
                
                console.log('âœ… Upload successful:', publicUrl);
                
                // ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ì‹¤ì œ íŒŒì¼ë¡œ êµì²´
                replaceUploadPlaceholder(placeholderId, publicUrl, file.name, fileType);
                
                // ì„±ê³µ ë©”ì‹œì§€
                showToast(`${fileType === 'image' ? 'ì´ë¯¸ì§€' : 'ë™ì˜ìƒ'}ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                
            } catch (error) {
                console.error('âŒ Upload error:', error);
                
                // ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±°
                if (placeholderId) {
                    removeUploadPlaceholder(placeholderId);
                }
                
                showToast(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // Global variable to track uploaded files
        window.uploadedFiles = window.uploadedFiles || [];

        // HTML ì†ì„±ê°’ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
        function escapeHtmlAttribute(str) {
            if (!str) return '';
            return str.replace(/"/g, '&quot;')
                     .replace(/'/g, '&#39;')
                     .replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;');
        }

        // ì—…ë¡œë“œ ë¡œë”© ìŠ¤í”¼ë„ˆ ì‚½ì…
        function insertUploadPlaceholder(filename, fileType) {
            const editorElement = document.getElementById('editor');
            const placeholderId = 'upload-placeholder-' + Date.now();
            
            // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
            const selection = window.getSelection();
            const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            
            // ë¡œë”© ìŠ¤í”¼ë„ˆ HTML ìƒì„±
            const placeholderHtml = `
                <div id="${placeholderId}" class="image-upload-placeholder">
                    <div class="upload-spinner"></div>
                    <div class="upload-status">ì—…ë¡œë“œ ì¤‘...</div>
                    <div class="upload-filename">${filename}</div>
                </div>
            `;
            
            // ì—ë””í„°ì— ì‚½ì…
            if (range) {
                // í˜„ì¬ ì»¤ì„œê°€ ìˆëŠ” ìš”ì†Œ í™•ì¸
                const currentElement = range.commonAncestorContainer;
                const parentElement = currentElement.nodeType === Node.TEXT_NODE ? 
                    currentElement.parentElement : currentElement;
                
                // í…ìŠ¤íŠ¸ ë¸”ë¡(p, div ë“±) ë‚´ë¶€ì— ìˆëŠ”ì§€ í™•ì¸
                const textBlock = parentElement.closest('p, div:not(#editor)');
                
                if (textBlock && textBlock !== editorElement) {
                    // í…ìŠ¤íŠ¸ ë¸”ë¡ ë‚´ë¶€ì— ìˆëŠ” ê²½ìš°, ë¸”ë¡ì„ ë¶„ë¦¬
                    console.log('ğŸ“ Inside text block, breaking it properly...');
                    
                    // execCommandë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì¤„ ì¶”ê°€ (ë¸”ë¡ ë¶„ë¦¬)
                    document.execCommand('insertHTML', false, '<br><br>');
                    
                    // ìƒˆë¡œìš´ ì„ íƒ ë²”ìœ„ ìƒì„±
                    const newSelection = window.getSelection();
                    const newRange = document.createRange();
                    
                    // í”Œë ˆì´ìŠ¤í™€ë” ìš”ì†Œ ìƒì„± ë° ì‚½ì…
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = placeholderHtml;
                    const placeholderElement = tempDiv.firstElementChild;
                    
                    // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
                    if (newSelection.rangeCount > 0) {
                        const currentRange = newSelection.getRangeAt(0);
                        currentRange.insertNode(placeholderElement);
                        
                        // ì»¤ì„œë¥¼ í”Œë ˆì´ìŠ¤í™€ë” ë‹¤ìŒì— ìƒˆ ì¤„ë¡œ ì´ë™
                        const afterRange = document.createRange();
                        afterRange.setStartAfter(placeholderElement);
                        afterRange.collapse(true);
                        
                        // í”Œë ˆì´ìŠ¤í™€ë” ë‹¤ìŒì— ìƒˆ ì¤„ ì¶”ê°€
                        const newLineDiv = document.createElement('div');
                        newLineDiv.innerHTML = '<br>';
                        afterRange.insertNode(newLineDiv);
                        
                        // ì»¤ì„œë¥¼ ìƒˆ ì¤„ë¡œ ì´ë™
                        afterRange.setStart(newLineDiv, 0);
                        afterRange.collapse(true);
                        
                        newSelection.removeAllRanges();
                        newSelection.addRange(afterRange);
                    }
                } else {
                    // ì¼ë°˜ì ì¸ ê²½ìš° (ë¸”ë¡ ì™¸ë¶€ ë˜ëŠ” ì—ë””í„° ìµœìƒìœ„)
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = placeholderHtml;
                    const placeholderElement = tempDiv.firstElementChild;
                    
                    range.deleteContents();
                    range.insertNode(placeholderElement);
                    
                    // ì»¤ì„œë¥¼ í”Œë ˆì´ìŠ¤í™€ë” ë‹¤ìŒìœ¼ë¡œ ì´ë™
                    range.setStartAfter(placeholderElement);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            } else {
                // ì»¤ì„œ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ëì— ì¶”ê°€
                editorElement.insertAdjacentHTML('beforeend', placeholderHtml);
            }
            
            // ì—ë””í„°ì— í¬ì»¤ìŠ¤
            editorElement.focus();
            
            return placeholderId;
        }

        // ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ì‹¤ì œ ì½˜í…ì¸ ë¡œ êµì²´
        function replaceUploadPlaceholder(placeholderId, url, filename, fileType) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) return;
            
            // íŒŒì¼ ì •ë³´ ì €ì¥
            const fileInfo = {
                url: url,
                filename: filename,
                type: fileType,
                uploadedAt: new Date().toISOString()
            };
            window.uploadedFiles.push(fileInfo);
            
            let contentHtml = '';
            
            if (fileType === 'image') {
                // Google Drive URLì„ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜
                let imageUrl = url;
                const fileIdMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (fileIdMatch) {
                    const fileId = fileIdMatch[1];
                    imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                }
                
                // DOM ìš”ì†Œë¡œ ì•ˆì „í•˜ê²Œ ìƒì„±
                const containerDiv = document.createElement('div');
                containerDiv.style.cssText = 'margin: 20px 0; padding: 0; clear: both; display: block; text-align: center;';
                
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = filename;
                img.style.cssText = 'max-width: 100%; height: auto; max-height: 500px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; margin: 0 auto;';
                img.loading = 'lazy';
                
                containerDiv.appendChild(img);
                contentHtml = containerDiv.outerHTML;
            } else if (fileType === 'video') {
                contentHtml = `
                    <div style="margin: 20px 0; padding: 0; clear: both; display: block; text-align: center;">
                        <video controls style="max-width: 100%; height: auto; max-height: 500px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; margin: 0 auto;">
                            <source src="${url}" type="video/mp4">
                            ë¸Œë¼ìš°ì €ì—ì„œ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </video>
                    </div>
                `;
            }
            
            // í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ì½˜í…ì¸ ë¡œ êµì²´
            placeholder.outerHTML = contentHtml;
            
            console.log('ğŸ”„ Replaced placeholder with content:', { url, filename, fileType });
        }

        // ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±° (ì—ëŸ¬ ì‹œ)
        function removeUploadPlaceholder(placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (placeholder) {
                placeholder.remove();
            }
        }

        function insertUploadedFile(url, filename, fileType) {
            console.log('ğŸ” Checking editor availability...');
            console.log('window.editor:', window.editor);
            console.log('document.getElementById("editor"):', document.getElementById('editor'));
            
            // ì—ë””í„° ìš”ì†Œ ì§ì ‘ ì°¾ê¸°
            const editorElement = document.getElementById('editor');
            if (!editorElement) {
                console.error('âŒ Editor element not found');
                showToast('ì—ë””í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            console.log('âœ… Editor element found, inserting content...');
            
            // Add to uploaded files list
            const fileInfo = {
                url: url,
                filename: filename,
                type: fileType,
                uploadedAt: new Date().toISOString()
            };
            window.uploadedFiles.push(fileInfo);
            
            console.log('ğŸ“ Inserting file into editor:', { url, filename, fileType });
            
            // ì—ë””í„°ì— í¬ì»¤ìŠ¤
            editorElement.focus();
            
            // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
            const selection = window.getSelection();
            const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            
            if (fileType === 'image') {
                // ì´ë¯¸ì§€ ì‚½ì… - Google Drive URL ì²˜ë¦¬
                console.log('ğŸ–¼ï¸ Original URL:', url);
                
                // Google Drive URLì„ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜
                let imageUrl = url;
                const fileIdMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (fileIdMatch) {
                    const fileId = fileIdMatch[1];
                    // ì—¬ëŸ¬ URL í˜•íƒœ ì‹œë„
                    imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                    console.log('ğŸ”„ Converted to thumbnail URL:', imageUrl);
                }
                
                // DOM ìš”ì†Œë¡œ ì•ˆì „í•˜ê²Œ ìƒì„±
                const containerDiv = document.createElement('div');
                containerDiv.style.cssText = 'margin: 16px 0; text-align: center;';
                
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = filename;
                img.style.cssText = 'max-width: 100%; height: 640px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                img.loading = 'lazy';
                img.onerror = function() {
                    this.onerror = null;
                    this.src = url;
                    console.log('ğŸ”„ Fallback to original URL:', url);
                };
                img.onload = function() {
                    console.log('âœ… Image loaded successfully:', this.src);
                };
                
                containerDiv.appendChild(img);
                const imageHtml = containerDiv.outerHTML;
                
                // ë°©ë²• 1: execCommand ì‚¬ìš©
                try {
                    console.log('ğŸ”§ Trying execCommand...');
                    console.log('ğŸ“„ Image HTML:', imageHtml.substring(0, 200) + '...');
                    
                    const result = document.execCommand('insertHTML', false, imageHtml);
                    console.log('âœ… execCommand result:', result);
                    
                    // ì‹¤ì œë¡œ ì‚½ì…ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    console.log('ğŸ“ Editor content after insert:', editorElement.innerHTML.length, 'chars');
                    
                    // ì‚½ì…ëœ ì´ë¯¸ì§€ ìš”ì†Œ ì°¾ì•„ì„œ ë¡œë“œ ìƒíƒœ í™•ì¸
                    setTimeout(() => {
                        const insertedImages = editorElement.querySelectorAll('img');
                        const lastImage = insertedImages[insertedImages.length - 1];
                        if (lastImage) {
                            console.log('ğŸ–¼ï¸ Inserted image element:', lastImage);
                            console.log('ğŸ”— Image src:', lastImage.src);
                            console.log('ğŸ“Š Image complete:', lastImage.complete);
                            console.log('ğŸ“ Image naturalWidth:', lastImage.naturalWidth);
                            console.log('ğŸ“ Image naturalHeight:', lastImage.naturalHeight);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.log('âŒ execCommand failed:', error);
                    console.log('ğŸ”§ Trying innerHTML append...');
                    // ë°©ë²• 2: ì§ì ‘ HTML ì¶”ê°€
                    const currentContent = editorElement.innerHTML;
                    editorElement.innerHTML = currentContent + imageHtml;
                    console.log('âœ… innerHTML append completed');
                }
                
                showToast('ì´ë¯¸ì§€ê°€ ì—ë””í„°ì— ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
            } else if (fileType === 'video') {
                // ë¹„ë””ì˜¤ ì‚½ì… - Google Drive ìµœì í™” ë°©ì‹
                console.log('ğŸ¥ Processing video URL:', url);
                
                const fileIdMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                let videoHtml;
                
                if (fileIdMatch) {
                    const fileId = fileIdMatch[1];
                    console.log('ğŸ†” Video file ID:', fileId);
                    console.log('ğŸ¬ Creating Google Drive video card');
                    
                    videoHtml = `<div style="margin: 16px 0; text-align: center;">
                        <iframe src="https://drive.google.com/file/d/${fileId}/preview" 
                                width="100%" height="400" 
                                style="border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                onload="console.log('âœ… Video iframe loaded successfully');"
                                onerror="console.log('âŒ Video iframe failed to load');">
                        </iframe>
                    </div>`;
                } else {
                    // ì¼ë°˜ ë¹„ë””ì˜¤ URLì¸ ê²½ìš°
                    videoHtml = `<div style="margin: 16px 0; text-align: center;">
                        <video controls style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <source src="${url}" type="${getMimeType(filename)}">
                            <p>ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                        </video>
                    </div>`;
                }
                
                // HTML ì‚½ì…
                try {
                    console.log('ğŸ”§ Inserting video HTML...');
                    const result = document.execCommand('insertHTML', false, videoHtml);
                    console.log('âœ… Video insertion result:', result);
                } catch (error) {
                    console.log('âŒ execCommand failed, using innerHTML...');
                    editorElement.innerHTML += videoHtml;
                }
                
                showToast('ë™ì˜ìƒì´ ì—ë””í„°ì— ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
            
            // ì»¤ì„œë¥¼ ì‚½ì…ëœ ì½˜í…ì¸  ë’¤ë¡œ ì´ë™ ë° í¬ì»¤ìŠ¤
            setTimeout(() => {
                editorElement.focus();
                
                // ì—ë””í„° ëìœ¼ë¡œ ì»¤ì„œ ì´ë™
                try {
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(editorElement);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } catch (error) {
                    console.log('Cursor positioning failed:', error);
                }
            }, 100);
        }

        function getMimeType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const mimeTypes = {
                // ë™ì˜ìƒ
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'ogg': 'video/ogg',
                'ogv': 'video/ogg',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'qt': 'video/quicktime',
                'wmv': 'video/x-ms-wmv',
                'flv': 'video/x-flv',
                'mkv': 'video/x-matroska',
                'm4v': 'video/mp4',
                '3gp': 'video/3gpp',
                '3g2': 'video/3gpp2',
                // ì´ë¯¸ì§€
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'webp': 'image/webp',
                'svg': 'image/svg+xml',
                'bmp': 'image/bmp',
                // ì˜¤ë””ì˜¤
                'mp3': 'audio/mpeg',
                'wav': 'audio/wav',
                'oga': 'audio/ogg',
                'm4a': 'audio/mp4',
                'aac': 'audio/aac'
            };
            
            const mimeType = mimeTypes[ext] || 'video/mp4';
            console.log(`ğŸ” File: ${filename} â†’ Extension: ${ext} â†’ MIME: ${mimeType}`);
            return mimeType;
        }

        // Drag and Drop functionality
        function initializeDragAndDrop() {
            const editor = document.getElementById('editor');
            
            // Drag over
            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.add('drag-over');
                editor.style.backgroundColor = 'rgba(74, 185, 255, 0.1)';
                editor.style.borderColor = '#4ab9ff';
            });
            
            // Drag leave
            editor.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.remove('drag-over');
                editor.style.backgroundColor = '';
                editor.style.borderColor = '';
            });
            
            // Drop
            editor.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.remove('drag-over');
                editor.style.backgroundColor = '';
                editor.style.borderColor = '';
                
                const files = Array.from(e.dataTransfer.files);
                console.log('ğŸ“ Files dropped:', files.length);
                
                // ì¸ì¦ í™•ì¸
                if (!window.driveUploader || !window.driveUploader.isAuthenticated) {
                    showToast('ë¨¼ì € Google Drive ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš” (ğŸ” ë²„íŠ¼ í´ë¦­)', 'error');
                    return;
                }
                
                files.forEach(file => {
                    console.log('ğŸ“„ Processing file:', file.name, file.type);
                    
                    if (file.type.startsWith('image/')) {
                        handleFileUpload([file], 'image');
                    } else if (file.type.startsWith('video/')) {
                        handleFileUpload([file], 'video');
                    } else {
                        showToast(`ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: ${file.name}`, 'error');
                    }
                });
            });
        }

        // Simple toast notification function
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 4px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // Initialize drag and drop when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ê´€ë¦¬ì ì¸ì¦ í™•ì¸
            if (!checkAdminAuth()) {
                return; // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì´ˆê¸°í™” ì¤‘ë‹¨
            }
            
            initializeDragAndDrop();
            
            // Initialize DriveUploader with auto-login
            await initializeDriveUploader();
            
            // ì´ˆê¸°í™” í›„ ì¸ì¦ ìƒíƒœ í™•ì¸
            setTimeout(() => {
                if (window.driveUploader) {
                    updateAuthButton(window.driveUploader.isAuthenticated);
                }
            }, 1000);
        });
    </script>

    <!-- Hidden File Input Elements -->
    <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="setTimeout(() => handleFileUpload(this.files, 'image'), 100)">
    <input type="file" id="videoFileInput" accept="video/*" style="display: none;" onchange="setTimeout(() => handleFileUpload(this.files, 'video'), 100)">
</body>
</html>