<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î¶¨Ïπò ÌÖçÏä§Ìä∏ ÏóêÎîîÌÑ∞ - My Blog</title>
    <!-- Icon -->
    <link rel="shortcut icon" href="./assets/Vector.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/editor.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google API Libraries -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <!-- Icon meta js -->
    <script src="js/head-meta.js"></script>
    <!-- Auth js -->
    <script src="js/auth.js"></script>
    
    <style>
        .backBtn:hover {
            background-color: #f5f5f5 !important;
        }
    </style>
</head>
<body class="editor">
    <!-- Ïù∏Ï¶ù ÌôïÏù∏ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script>
        // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ïù∏Ï¶ù ÌôïÏù∏
        if (!Auth.isLoggedIn()) {
            Auth.redirectToLogin();
        }
    </script>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-actions">
                <div class="header-left">
                    <button onclick="history.back()" class="backBtn" style="background: none; border: none; color: #333; font-size: 1rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 4px; transition: background-color 0.2s ease;">
                        ‚Üê 
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Toolbar Section -->
    <div class="toolbar-section">
        <div class="container">
            <div class="header-toolbar">
                <div class="simple-toolbar">
                    
                    <select onchange="format('formatBlock', this.value); this.value=''; setTimeout(() => { if(window.editor) { window.editor.editor.focus(); window.editor.moveCaretToEnd(); } }, 10);">
                        <option value="">Îã®ÎùΩ Ïä§ÌÉÄÏùº</option>
                        <option value="h1">Ï†úÎ™© 1</option>
                        <option value="h2">Ï†úÎ™© 2</option>
                        <option value="h3">Ï†úÎ™© 3</option>
                        <option value="p">Î≥∏Î¨∏</option>
                    </select>
                    
                    <select onchange="format('fontSize', this.value); this.value=''; setTimeout(() => { if(window.editor) { window.editor.editor.focus(); window.editor.moveCaretToEnd(); } }, 10);">
                        <option value="">Í∏ÄÏûê ÌÅ¨Í∏∞</option>
                        <option value="1">Îß§Ïö∞ ÏûëÍ≤å</option>
                        <option value="3">ÏûëÍ≤å</option>
                        <option value="5">Î≥¥ÌÜµ</option>
                        <option value="6">ÌÅ¨Í≤å</option>
                        <option value="7">Îß§Ïö∞ ÌÅ¨Í≤å</option>
                    </select>
                    
                    <div class="separator"></div>
                    <button onclick="format('bold'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ÍµµÍ≤å (Ctrl+B)"><b>B</b></button>
                    <button onclick="format('italic'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Í∏∞Ïö∏ÏûÑ (Ctrl+I)"><i>I</i></button>
                    <button onclick="format('underline'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Î∞ëÏ§Ñ (Ctrl+U)"><u>U</u></button>
                    <button onclick="format('strikeThrough'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Ï∑®ÏÜåÏÑ†"><s>S</s></button>
                    <div class="separator"></div>
                    <div class="color-button-wrapper">
                        <button class="color-button text-color-btn" onclick="document.getElementById('textColor').click()" title="Í∏ÄÏûê ÏÉâ">
                            <span class="color-letter">A</span>
                            <span class="color-bar" id="textColorBar"></span>
                            <input type="color" id="textColor" onchange="changeTextColor(this.value)" style="display: none;">
                        </button>
                    </div>
                    <div class="color-picker">
                        <input type="color" id="bgColor" onchange="changeBgColor(this.value)" title="Î∞∞Í≤Ω ÏÉâ">
                    </div>                        
                    
                    <div class="separator"></div>
                    
                    <button onclick="format('insertUnorderedList'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Í∏ÄÎ®∏Î¶¨ Í∏∞Ìò∏">‚Ä¢</button>
                    <button onclick="format('insertOrderedList'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Î≤àÌò∏ Îß§Í∏∞Í∏∞">1.</button>
                    
                    <div class="separator"></div>
                    
                    <button onclick="format('justifyLeft'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ÏôºÏ™Ω Ï†ïÎ†¨">L</button>
                    <button onclick="format('justifyCenter'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨">C</button>
                    <button onclick="format('justifyRight'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Ïò§Î•∏Ï™Ω Ï†ïÎ†¨">R</button>
                    <button onclick="format('justifyFull'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ÏñëÏ™Ω Ï†ïÎ†¨">‚â°</button>
                    
                    
                    
                    <div class="separator"></div>
                    
                    <button id="linkToggleBtn" onclick="toggleLink(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ÎßÅÌÅ¨">üîó</button>
                    
                    <button id="imageUploadBtn" onclick="openImageUpload(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú">üì∑</button>
                    <button id="videoUploadBtn" onclick="openVideoUpload(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="ÎπÑÎîîÏò§ ÏóÖÎ°úÎìú">üé•</button>
                    
                    <div class="separator"></div>
                    
                    <button onclick="format('undo'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Ïã§Ìñâ Ï∑®ÏÜå">‚Ü∂</button>
                    <button onclick="format('redo'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="Îã§Ïãú Ïã§Ìñâ">‚Ü∑</button>
                    
                    <div class="separator"></div>
                    
                    <button id="codeViewToggle" onclick="toggleCodeView(); setTimeout(() => { if(window.editor && !window.editor.isCodeView) { window.editor.editor.focus(); } }, 10);" title="HTML ÏΩîÎìú Î≥¥Í∏∞">HTML</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="editor-container">
                <!-- Editor Header -->
                <div class="editor-header">
                </div>

                <!-- Post Metadata -->
                <div class="post-metadata">
                    <input type="text" id="postTitle" placeholder="Untitled..." class="title-input">
                </div>
                
                <!-- Simple Editor Container -->
                <div class="simple-editor-wrapper">
                    <div class="simple-editor" contenteditable="true" id="editor">
                        <div>Ïó¨Í∏∞Ïóê ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <span id="progressText">ÏóÖÎ°úÎìú Ï§ë...</span>
                </div>
                
                <!-- Editor Actions -->
            </div>
        </div>
    </main>
    
    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container">
        <!-- ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="tags-container">
            <div class="tags-wrapper" id="tagsWrapper">
                <!-- ÌÉúÍ∑∏Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                <input type="text" id="tagInput" class="tag-input" placeholder="#ÌÉúÍ∑∏ÏûÖÎ†•">
            </div>
        </div>
        <div class="container">
            <div class="footer-actions">
                <div class="footer-left">
                    <select id="statusSelect" class="status-select">
                        <option value="published" selected>Î∞úÌñâÎê®</option>
                        <option value="private">ÎπÑÍ≥µÍ∞ú</option>
                    </select>
                </div>
                <div class="footer-center">
                    <div class="datetime-display" id="realtimeClock"></div>
                </div>
                <div class="footer-right">
                    <button type="button" class="btn btn-success" id="saveBtn">Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/drive-uploader.js"></script>
    <script src="js/upload.js"></script>
    <script src="js/editor.js"></script>
    
    <script>
        // Ïã§ÏãúÍ∞Ñ ÏãúÍ≥Ñ Í∏∞Îä•
        function updateClock() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timeString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            document.getElementById('realtimeClock').textContent = timeString;
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏãúÍ≥Ñ ÏãúÏûë
        document.addEventListener('DOMContentLoaded', function() {
            updateClock(); // Ï¶âÏãú ÌëúÏãú
            setInterval(updateClock, 1000); // Îß§Ï¥à ÏóÖÎç∞Ïù¥Ìä∏
        });
    </script>
    
    <!-- Tags Input Script -->
    <script>
        // Tags functionality
        class TagsInput {
            constructor() {
                this.tags = [];
                this.tagInput = document.getElementById('tagInput');
                this.tagsWrapper = document.getElementById('tagsWrapper');
                
                this.init();
            }
            
            init() {
                this.tagInput.addEventListener('keydown', (e) => {
                    if (e.key === ',' || e.key === 'Enter') {
                        e.preventDefault();
                        this.addTag();
                    } else if (e.key === 'Backspace' && this.tagInput.value === '') {
                        this.removeLastTag();
                    }
                });
                
                this.tagInput.addEventListener('blur', () => {
                    if (this.tagInput.value.trim()) {
                        this.addTag();
                    }
                });
            }
            
            addTag() {
                const value = this.tagInput.value.trim();
                if (value && !this.tags.includes(value)) {
                    this.tags.push(value);
                    this.renderTags();
                    this.tagInput.value = '';
                }
            }
            
            removeTag(tagToRemove) {
                this.tags = this.tags.filter(tag => tag !== tagToRemove);
                this.renderTags();
            }
            
            removeLastTag() {
                if (this.tags.length > 0) {
                    this.tags.pop();
                    this.renderTags();
                }
            }
            
            renderTags() {
                // Í∏∞Ï°¥ ÌÉúÍ∑∏Îì§ Ï†úÍ±∞ (input Ï†úÏô∏)
                const existingTags = this.tagsWrapper.querySelectorAll('.tag');
                existingTags.forEach(tag => tag.remove());
                
                // ÏÉà ÌÉúÍ∑∏Îì§ Ï∂îÍ∞Ä
                this.tags.forEach(tagText => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        <span>${tagText}</span>
                        <button type="button" class="tag-remove" onclick="tagsInput.removeTag('${tagText}')">&times;</button>
                    `;
                    
                    // input ÏïûÏóê ÏÇΩÏûÖ
                    this.tagsWrapper.insertBefore(tagElement, this.tagInput);
                });
            }
            
            getTags() {
                return this.tags;
            }
            
            setTags(tags) {
                this.tags = tags || [];
                this.renderTags();
            }
            
            getTagsString() {
                return this.tags.join(', ');
            }
        }
        
        // Ïä§ÎßàÌä∏ ÎßÅÌÅ¨ ÌÜ†Í∏Ä Ìï®Ïàò
        function toggleLink() {
            const selection = window.getSelection();
            const linkBtn = document.getElementById('linkToggleBtn');
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let parentElement = range.commonAncestorContainer;
                
                // ÌÖçÏä§Ìä∏ ÎÖ∏ÎìúÏù∏ Í≤ΩÏö∞ Î∂ÄÎ™® ÏöîÏÜå Ï∞æÍ∏∞
                if (parentElement.nodeType === Node.TEXT_NODE) {
                    parentElement = parentElement.parentElement;
                }
                
                // ÌòÑÏû¨ ÏÑ†ÌÉù ÏòÅÏó≠Ïù¥ ÎßÅÌÅ¨ ÏïàÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                let linkElement = null;
                let currentElement = parentElement;
                
                // Î∂ÄÎ™®Î•º Í±∞Ïä¨Îü¨ Ïò¨ÎùºÍ∞ÄÎ©∞ ÎßÅÌÅ¨ ÏöîÏÜå Ï∞æÍ∏∞
                while (currentElement && currentElement !== document.body) {
                    if (currentElement.tagName === 'A') {
                        linkElement = currentElement;
                        break;
                    }
                    currentElement = currentElement.parentElement;
                }
                
                if (linkElement) {
                    // ÎßÅÌÅ¨Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
                    format('unlink');
                    linkBtn.textContent = 'üîó';
                    linkBtn.title = 'ÎßÅÌÅ¨ ÏÇΩÏûÖ';
                    linkBtn.style.color = '';
                } else {
                    // ÎßÅÌÅ¨Í∞Ä ÏóÜÏúºÎ©¥ ÏÇΩÏûÖ
                    if (selection.toString().trim()) {
                        // ÌÖçÏä§Ìä∏Í∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞
                        insertLink();
                        linkBtn.textContent = 'üîó';
                        linkBtn.title = 'ÎßÅÌÅ¨ Ï†úÍ±∞';
                        linkBtn.style.color = '#007bff';
                    } else {
                        // ÌÖçÏä§Ìä∏Í∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
                        alert('ÎßÅÌÅ¨Î•º Ï∂îÍ∞ÄÌï† ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    }
                }
            } else {
                alert('ÎßÅÌÅ¨Î•º Ï∂îÍ∞ÄÌï† ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
            }
            
            // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updateLinkButtonState();
        }
        
        // ÎßÅÌÅ¨ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateLinkButtonState() {
            const linkBtn = document.getElementById('linkToggleBtn');
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let parentElement = range.commonAncestorContainer;
                
                if (parentElement.nodeType === Node.TEXT_NODE) {
                    parentElement = parentElement.parentElement;
                }
                
                // ÎßÅÌÅ¨ ÏöîÏÜå Ï∞æÍ∏∞
                let currentElement = parentElement;
                let hasLink = false;
                
                while (currentElement && currentElement !== document.body) {
                    if (currentElement.tagName === 'A') {
                        hasLink = true;
                        break;
                    }
                    currentElement = currentElement.parentElement;
                }
                
                if (hasLink) {
                    linkBtn.style.backgroundColor = '#007bff';
                    linkBtn.style.color = 'white';
                    linkBtn.title = 'ÎßÅÌÅ¨ Ï†úÍ±∞';
                } else {
                    linkBtn.style.backgroundColor = '';
                    linkBtn.style.color = '';
                    linkBtn.title = 'ÎßÅÌÅ¨ ÏÇΩÏûÖ';
                }
            }
        }
        
        // ÏóêÎîîÌÑ∞ÏóêÏÑú ÏÑ†ÌÉù Î≥ÄÍ≤Ω Ïãú ÎßÅÌÅ¨ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        document.addEventListener('selectionchange', () => {
            if (document.getElementById('linkToggleBtn')) {
                updateLinkButtonState();
            }
        });

        // Initialize tags input when DOM is ready
        let tagsInput;
        document.addEventListener('DOMContentLoaded', () => {
            tagsInput = new TagsInput();
            window.tagsInput = tagsInput; // Ï†ÑÏó≠ Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù
            
            // Initialize uploaded files list for new post
            resetUploadedFiles();
        });

        // Google Drive Upload Functions
        function openImageUpload() {
            document.getElementById('imageFileInput').click();
        }

        function openVideoUpload() {
            document.getElementById('videoFileInput').click();
        }

        async function handleFileUpload(files, fileType) {
            if (!files || files.length === 0) return;

            const file = files[0];
            
            try {
                // DriveUploader Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
                const uploader = new DriveUploader();
                
                // ÌååÏùº ÏóÖÎ°úÎìú Ïã§Ìñâ
                const result = await uploader.uploadFile(file, fileType);
                
                if (result.success) {
                    // ÏóêÎîîÌÑ∞Ïóê ÏóÖÎ°úÎìúÎêú ÌååÏùº ÏÇΩÏûÖ
                    insertUploadedFile(result.url, file.name, fileType);
                } else {
                    alert('ÏóÖÎ°úÎìú Ïã§Ìå®: ' + result.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Global variable to track uploaded files
        window.uploadedFiles = window.uploadedFiles || [];

        function insertUploadedFile(url, filename, fileType) {
            if (!window.editor) return;

            const editor = window.editor.editor;
            
            // Add to uploaded files list
            const fileInfo = {
                url: url,
                filename: filename,
                type: fileType,
                uploadedAt: new Date().toISOString()
            };
            window.uploadedFiles.push(fileInfo);
            
            if (fileType === 'image') {
                // Ïù¥ÎØ∏ÏßÄ ÏÇΩÏûÖ
                const img = `<img src="${url}" alt="${filename}" style="max-width: 100%; height: auto;">`;
                document.execCommand('insertHTML', false, img);
            } else if (fileType === 'video') {
                // ÎπÑÎîîÏò§ ÏÇΩÏûÖ
                const video = `<video controls style="max-width: 100%; height: auto;">
                    <source src="${url}" type="${getMimeType(filename)}">
                    <a href="${url}">${filename}</a>
                </video>`;
                document.execCommand('insertHTML', false, video);
            }
            
            editor.focus();
        }

        function getMimeType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const mimeTypes = {
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'ogg': 'video/ogg',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'wmv': 'video/x-ms-wmv'
            };
            return mimeTypes[ext] || 'video/mp4';
        }

        // Drag and Drop functionality
        function initializeDragAndDrop() {
            const editor = document.getElementById('editor');
            
            // Drag over
            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.add('drag-over');
            });
            
            // Drag leave
            editor.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.remove('drag-over');
            });
            
            // Drop
            editor.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        handleFileUpload([file], 'image');
                    } else if (file.type.startsWith('video/')) {
                        handleFileUpload([file], 'video');
                    } else {
                        alert(`ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§: ${file.name}`);
                    }
                });
            });
        }

        // Initialize drag and drop when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeDragAndDrop();
        });
    </script>

    <!-- Hidden File Input Elements -->
    <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(this.files, 'image')">
    <input type="file" id="videoFileInput" accept="video/*" style="display: none;" onchange="handleFileUpload(this.files, 'video')">
</body>
</html>