<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리치 텍스트 에디터 - My Blog</title>
    <!-- Icon -->
    <link rel="shortcut icon" href="./assets/Vector.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/editor.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google API Libraries -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Icon meta js -->
    <script src="js/head-meta.js"></script>
    <!-- Debug Logger -->
    <script src="js/debug-logger.js"></script>
    <!-- Auth js -->
    <script src="js/auth.js"></script>

    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/0470599ade.js" crossorigin="anonymous"></script>
    
    <!-- Simple Tags Input -->
    <script src="js/tags-input-simple.js"></script>
    
    <style>
        .backBtn:hover {
            background-color: #f5f5f5 !important;
        }
        
        /* 드래그 앤 드롭 스타일 */
        .simple-editor.drag-over {
            background-color: rgba(74, 185, 255, 0.1) !important;
            border: 2px dashed #4ab9ff !important;
            transition: all 0.2s ease;
        }
        
        .simple-editor::after {
            content: '';
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(74, 185, 255, 0.9);
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            pointer-events: none;
            z-index: 1000;
        }
        
        .simple-editor.drag-over::after {
            content: '📎 파일을 여기에 드롭하세요';
            display: block;
        }
        
        /* 업로드된 미디어 스타일 */
        .simple-editor img {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .simple-editor img:hover {
            transform: scale(1.02);
        }
        
        .simple-editor iframe {
            border-radius: 8px;
        }
    </style>
</head>
<body class="editor">
    <!-- 인증 확인 스크립트 -->
    <script>
        // 페이지 로드시 인증 확인
        if (!Auth.isLoggedIn()) {
            Auth.redirectToLogin();
        }
    </script>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-actions">
                <div class="header-left">
                    <button onclick="history.back()" class="backBtn" style="background: none; border: none; color: #333; font-size: 1rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 4px; transition: background-color 0.2s ease;">
                        ← 
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Toolbar Section -->
    <div class="toolbar-section">
        <div class="container">
            <div class="header-toolbar">
                <div class="simple-toolbar">
                    
                    <select onchange="format('formatBlock', this.value); this.value=''; setTimeout(() => { if(window.editor) { window.editor.editor.focus(); window.editor.moveCaretToEnd(); } }, 10);">
                        <option value="">단락 스타일</option>
                        <option value="h1">제목 1</option>
                        <option value="h2">제목 2</option>
                        <option value="h3">제목 3</option>
                        <option value="p">본문</option>
                    </select>
                    
                    <button onclick="format('bold'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="굵게 (Ctrl+B)"><b>B</b></button>
                    <button onclick="format('italic'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="기울임 (Ctrl+I)"><i>I</i></button>
                    <button onclick="format('underline'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="밑줄 (Ctrl+U)"><u>U</u></button>
                    <button onclick="format('strikeThrough'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="취소선"><s>S</s></button>

                    <div class="color-button-wrapper">
                        <button class="color-button text-color-btn" onclick="document.getElementById('textColor').click()" title="글자 색">
                            <span class="color-letter">A</span>
                            <span class="color-bar" id="textColorBar"></span>
                            <input type="color" id="textColor" onchange="changeTextColor(this.value)" style="display: none;">
                        </button>
                    </div>
                    
                    <div class="highlight-wrapper">
                        <button class="highlight-btn" onclick="toggleHighlight()" title="하이라이트">
                            <div class="highlight-color-display" id="highlightColorDisplay"></div>
                        </button>
                        <div class="highlight-colors" id="highlightColors" style="display: none;">
                            <button class="highlight-color" style="background-color: #ffff6b;" onclick="applyHighlight('#ffff6b')" title="노란색"></button>
                            <button class="highlight-color" style="background-color: #93ff6b;" onclick="applyHighlight('#93ff6b')" title="연두색"></button>
                            <button class="highlight-color" style="background-color: #b3fffa;" onclick="applyHighlight('#b3fffa')" title="하늘색"></button>
                            <button class="highlight-color" style="background-color: #b3b5ff;" onclick="applyHighlight('#b3b5ff')" title="보라색"></button>
                            <button class="highlight-color" style="background-color: #fbc7ff;" onclick="applyHighlight('#fbc7ff')" title="분홍색"></button>
                            <button class="highlight-color" style="background-color: #ffc2c2;" onclick="applyHighlight('#ffc2c2')" title="빨간색"></button>
                        </div>
                    </div>

                    <button onclick="format('insertUnorderedList'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="글머리 기호">•</button>
                    <button onclick="format('insertOrderedList'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="번호 매기기">1.</button>
                                        
                    <button onclick="format('justifyLeft'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="왼쪽 정렬"><i class="fa-solid fa-align-left"></i></button>
                    <button onclick="format('justifyCenter'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="가운데 정렬"><i class="fa-solid fa-align-center"></i></button>
                    <button onclick="format('justifyRight'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="오른쪽 정렬"><i class="fa-solid fa-align-right"></i></button>
                    <button onclick="format('justifyFull'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="양쪽 정렬"><i class="fa-solid fa-align-justify"></i></button>
                                        
                    <button id="linkToggleBtn" onclick="toggleLink(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="링크">🔗</button>
                    
                    <button id="imageUploadBtn" onclick="openImageUpload(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="이미지 업로드"><i class="fa-solid fa-image"></i></button>
                    <button id="videoUploadBtn" onclick="openVideoUpload(); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="비디오 업로드"><i class="fa-solid fa-video"></i></button>
                                        
                    <button onclick="format('undo'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="실행 취소">↶</button>
                    <button onclick="format('redo'); setTimeout(() => { if(window.editor) { window.editor.editor.focus(); } }, 10);" title="다시 실행">↷</button>
                                        
                    <button id="codeViewToggle" onclick="toggleCodeView(); setTimeout(() => { if(window.editor && !window.editor.isCodeView) { window.editor.editor.focus(); } }, 10);" title="HTML 코드 보기">HTML</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="editor-container">
                <!-- Editor Header -->
                <div class="editor-header">
                </div>

                <!-- Post Metadata -->
                <div class="post-metadata">
                    <input type="text" id="postTitle" placeholder="Untitled..." class="title-input">
                </div>
                
                <!-- Simple Editor Container -->
                <div class="simple-editor-wrapper">
                    <div class="simple-editor" contenteditable="true" id="editor">
                        <div>여기에 텍스트를 입력하세요.</div>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <span id="progressText">업로드 중...</span>
                </div>
                
                <!-- Editor Actions -->
            </div>
        </div>
    </main>
    
    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container">
        <!-- 토스트 메시지들이 동적으로 추가됩니다 -->
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="tags-container">
            <div class="tags-wrapper" id="tagsWrapper">
                <!-- 태그들이 여기에 동적으로 추가됩니다 -->
                <input type="text" id="tagInput" class="tag-input" placeholder="태그 입력 (쉼표나 엔터로 구분)">
            </div>
        </div>
        <div class="container">
            <div class="footer-actions">
                <div class="footer-left">
                    <select id="statusSelect" class="status-select">
                        <option value="published" selected>발행됨</option>
                        <option value="private">비공개</option>
                    </select>
                </div>
                <div class="footer-center">
                    <div class="datetime-display" id="realtimeClock"></div>
                </div>
                <div class="footer-right">
                    <button type="button" class="btn btn-success" id="saveBtn">저장</button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/sheets.js"></script>
    <script src="js/drive-uploader.js"></script>
    <script src="js/upload.js"></script>
    <script src="js/editor.js"></script>
    
    <script>
        // 실시간 시계 기능 (한국 시간대)
        function updateClock() {
            const kstTime = getKSTTime();
            
            const year = kstTime.getFullYear();
            const month = String(kstTime.getMonth() + 1).padStart(2, '0');
            const day = String(kstTime.getDate()).padStart(2, '0');
            const hours = String(kstTime.getHours()).padStart(2, '0');
            const minutes = String(kstTime.getMinutes()).padStart(2, '0');
            const seconds = String(kstTime.getSeconds()).padStart(2, '0');
            
            const timeString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            document.getElementById('realtimeClock').textContent = timeString;
        }
        
        // 페이지 로드 시 시계 시작
        document.addEventListener('DOMContentLoaded', function() {
            updateClock(); // 즉시 표시
            setInterval(updateClock, 1000); // 매초 업데이트
        });
    </script>
    
    <!-- Tags Input Script -->
    <script>
        // 간소화된 링크 토글 (editor.js 함수 사용)
        function toggleLink() {
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0 && selection.toString().trim()) {
                // editor.js의 insertLink 함수 사용
                if (window.editor) {
                    window.editor.insertLink();
                } else if (window.insertLink) {
                    window.insertLink();
                } else {
                    // 폴백: 기본 브라우저 기능 사용
                    const url = prompt('링크 URL을 입력하세요:', 'https://');
                    if (url) {
                        document.execCommand('createLink', false, url);
                    }
                }
            } else {
                alert('링크를 추가할 텍스트를 먼저 선택해주세요.');
            }
        }

        // Google Drive Upload Functions
        function openImageUpload() {
            // 사용자 클릭 액션을 바로 파일 선택에 사용
            document.getElementById('imageFileInput').click();
        }

        function openVideoUpload() {
            // 사용자 클릭 액션을 바로 파일 선택에 사용
            document.getElementById('videoFileInput').click();
        }

        // 파일 업로드 전 인증 확인 및 준비
        async function ensureAuthBeforeUpload() {
            try {
                // DriveUploader 인스턴스 확인 및 초기화
                if (!window.driveUploader) {
                    showToast('Google Drive 준비 중...', 'info');
                    await initializeDriveUploader();
                }
                
                // 이미 인증된 경우 바로 리턴
                if (window.driveUploader.isAuthenticated) {
                    return;
                }
                
                // 인증 필요한 경우 사용자에게 알리고 인증 진행
                showToast('Google 계정으로 로그인해주세요...', 'info');
                
                const authResult = await window.driveUploader.authenticate(false);
                
                if (authResult && authResult.success) {
                    showToast('인증 완료! 업로드를 시작합니다.', 'success');
                } else {
                    throw new Error('Google Drive 인증에 실패했습니다');
                }
                
            } catch (error) {
                console.error('❌ Auth failed:', error);
                showToast(`인증 실패: ${error.message}`, 'error');
                throw error;
            }
        }



        // 관리자 로그인 상태 확인
        function checkAdminAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');
            
            if (!token || !expires || Date.now() > parseInt(expires)) {
                // 관리자 로그인이 필요함
                alert('관리자 로그인이 필요합니다.');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // DriveUploader 초기화 및 자동 로그인 확인
        async function initializeDriveUploader() {
            console.log('🚀 Initializing DriveUploader...');
            
            // 관리자 인증 확인
            if (!checkAdminAuth()) {
                return;
            }
            
            window.driveUploader = new DriveUploader();
            
            // 명시적으로 초기화 실행
            await window.driveUploader.init();
            
            // 초기화 완료 대기
            await window.driveUploader.waitForInitialization();
            
            // 자동 로그인이 완료되었는지 확인 (UI 업데이트 없이)
            setTimeout(() => {
                if (window.driveUploader.isAuthenticated) {
                    console.log('✅ Auto-login successful - ready for file uploads');
                } else {
                    console.log('📭 Auto-login not available - will authenticate on file upload');
                }
            }, 3000);
        }
        


        async function handleFileUpload(files, fileType) {
            if (!files || files.length === 0) return;

            const file = files[0];
            let placeholderId = null;
            
            try {
                console.log('📤 Starting file upload:', file.name, fileType);
                
                // 업로드 시작 시 현재 커서 위치 저장 및 상태 설정
                const savedCursorPosition = saveCursorPosition();
                isUploadInProgress = true;
                setUploadButtonsEnabled(false);
                
                // 파일 선택 후 인증 확인 및 필요시 인증 진행
                await ensureAuthBeforeUpload();
                
                if (!window.driveUploader || !window.driveUploader.isAuthenticated) {
                    console.error('❌ Authentication failed');
                    showToast('Google Drive 인증에 실패했습니다.', 'error');
                    return;
                }
                
                // 업로드 시작 - 로딩 스피너 삽입 (저장된 커서 위치 사용)
                placeholderId = insertUploadPlaceholder(file.name, fileType, savedCursorPosition);
                showToast('파일 업로드 중...', 'info');
                
                // 파일 업로드 실행
                const publicUrl = await window.driveUploader.uploadFile(file, Date.now(), fileType);
                
                console.log('✅ Upload successful:', publicUrl);
                
                // 로딩 스피너를 실제 파일로 교체
                replaceUploadPlaceholder(placeholderId, publicUrl, file.name, fileType);
                
                // 성공 메시지
                showToast(`${fileType === 'image' ? '이미지' : '동영상'}가 업로드되었습니다!`, 'success');
                
                // 업로드 완료 상태 리셋
                isUploadInProgress = false;
                setUploadButtonsEnabled(true);
                
            } catch (error) {
                console.error('❌ Upload error:', error);
                
                // 에러 발생 시 로딩 스피너 제거
                if (placeholderId) {
                    removeUploadPlaceholder(placeholderId);
                }
                
                showToast(`업로드 실패: ${error.message}`, 'error');
                
                // 업로드 실패 상태 리셋
                isUploadInProgress = false;
                setUploadButtonsEnabled(true);
            }
        }

        // Global variable to track uploaded files
        window.uploadedFiles = window.uploadedFiles || [];
        
        // 업로드 상태 관리
        let isUploadInProgress = false;
        
        // 업로드 버튼 상태 관리
        function setUploadButtonsEnabled(enabled) {
            const imageBtn = document.getElementById('imageUploadBtn');
            const videoBtn = document.getElementById('videoUploadBtn');
            
            if (imageBtn) {
                imageBtn.disabled = !enabled;
                imageBtn.style.opacity = enabled ? '1' : '0.5';
                imageBtn.style.pointerEvents = enabled ? 'auto' : 'none';
            }
            
            if (videoBtn) {
                videoBtn.disabled = !enabled;
                videoBtn.style.opacity = enabled ? '1' : '0.5';
                videoBtn.style.pointerEvents = enabled ? 'auto' : 'none';
            }
        }

        // 커서 위치 저장/복원 함수들
        function saveCursorPosition() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                console.log('💾 No cursor position to save');
                return null;
            }
            
            const range = selection.getRangeAt(0);
            const editorElement = document.getElementById('editor');
            
            // 저장할 위치 정보 생성
            const savedPosition = {
                startContainer: range.startContainer,
                startOffset: range.startOffset,
                endContainer: range.endContainer,
                endOffset: range.endOffset,
                timestamp: Date.now()
            };
            
            console.log('💾 Cursor position saved at:', {
                startContainer: range.startContainer.nodeName,
                startOffset: range.startOffset,
                containerText: range.startContainer.textContent?.substring(0, 50) + '...'
            });
            
            return savedPosition;
        }
        
        function restoreCursorPosition(savedPosition) {
            if (!savedPosition) {
                console.log('📍 No saved cursor position to restore');
                return false;
            }
            
            try {
                const selection = window.getSelection();
                const range = document.createRange();
                
                // 저장된 위치로 커서 복원
                range.setStart(savedPosition.startContainer, savedPosition.startOffset);
                range.setEnd(savedPosition.endContainer, savedPosition.endOffset);
                
                selection.removeAllRanges();
                selection.addRange(range);
                
                console.log('📍 Cursor position restored');
                return true;
            } catch (error) {
                console.warn('⚠️ Failed to restore cursor position:', error);
                return false;
            }
        }

        // 로컬 시간 사용 (한국 사용자 기준)
        function getKSTTime() {
            // 사용자의 로컬 시간을 그대로 사용
            // 한국에 있는 사용자라면 로컬 시간이 곧 한국 시간
            return new Date();
        }

        // 업로드 로딩 스피너 삽입 (저장된 커서 위치 사용)
        function insertUploadPlaceholder(filename, fileType, savedCursorPosition = null) {
            const editorElement = document.getElementById('editor');
            const placeholderId = 'upload-placeholder-' + Date.now();
            
            // 저장된 커서 위치가 있으면 복원, 없으면 현재 위치 사용
            let range = null;
            if (savedCursorPosition && restoreCursorPosition(savedCursorPosition)) {
                const selection = window.getSelection();
                range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                console.log('📍 Using saved cursor position for placeholder');
            } else {
                const selection = window.getSelection();
                range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                console.log('📍 Using current cursor position for placeholder');
            }
            
            // 로딩 스피너 HTML 생성
            const placeholderHtml = `
                <div id="${placeholderId}" class="image-upload-placeholder">
                    <div class="upload-spinner"></div>
                    <div class="upload-status">업로드 중...</div>
                    <div class="upload-filename">${filename}</div>
                </div>
            `;
            
            // 에디터에 삽입
            if (range) {
                // 현재 커서가 있는 요소 확인
                const currentElement = range.commonAncestorContainer;
                const parentElement = currentElement.nodeType === Node.TEXT_NODE ? 
                    currentElement.parentElement : currentElement;
                
                // 텍스트 블록(p, div 등) 내부에 있는지 확인
                const textBlock = parentElement.closest('p, div:not(#editor)');
                
                if (textBlock && textBlock !== editorElement) {
                    // 텍스트 블록 내부에 있는 경우, 블록을 분리
                    console.log('📝 Inside text block, breaking it properly...');
                    
                    // execCommand를 사용하여 새 줄 추가 (블록 분리)
                    document.execCommand('insertHTML', false, '<br><br>');
                    
                    // 새로운 선택 범위 생성
                    const newSelection = window.getSelection();
                    const newRange = document.createRange();
                    
                    // 플레이스홀더 요소 생성 및 삽입
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = placeholderHtml;
                    const placeholderElement = tempDiv.firstElementChild;
                    
                    // 현재 커서 위치에 삽입
                    if (newSelection.rangeCount > 0) {
                        const currentRange = newSelection.getRangeAt(0);
                        currentRange.insertNode(placeholderElement);
                        
                        // 커서를 플레이스홀더 다음에 새 줄로 이동
                        const afterRange = document.createRange();
                        afterRange.setStartAfter(placeholderElement);
                        afterRange.collapse(true);
                        
                        // 플레이스홀더 다음에 새 줄 추가
                        const newLineDiv = document.createElement('div');
                        newLineDiv.innerHTML = '<br>';
                        afterRange.insertNode(newLineDiv);
                        
                        // 커서를 새 줄로 이동
                        afterRange.setStart(newLineDiv, 0);
                        afterRange.collapse(true);
                        
                        newSelection.removeAllRanges();
                        newSelection.addRange(afterRange);
                    }
                } else {
                    // 일반적인 경우 (블록 외부 또는 에디터 최상위)
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = placeholderHtml;
                    const placeholderElement = tempDiv.firstElementChild;
                    
                    range.deleteContents();
                    range.insertNode(placeholderElement);
                    
                    // 커서를 플레이스홀더 다음으로 이동
                    range.setStartAfter(placeholderElement);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            } else {
                // 커서 위치가 없으면 끝에 추가
                editorElement.insertAdjacentHTML('beforeend', placeholderHtml);
            }
            
            // 에디터에 포커스
            editorElement.focus();
            
            return placeholderId;
        }

        // 로딩 스피너를 실제 콘텐츠로 교체 (강화된 버전)
        function replaceUploadPlaceholder(placeholderId, url, filename, fileType) {
            console.log('🔄 Starting placeholder replacement:', { placeholderId, url, filename, fileType });
            
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) {
                console.error('❌ Placeholder not found:', placeholderId);
                return;
            }
            
            // 파일 정보 저장 (한국 시간대)
            const now = new Date();
            const kstOffset = 9 * 60; // 한국은 UTC+9
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const kstTime = new Date(utc + (kstOffset * 60000));
            
            const fileInfo = {
                url: url,
                filename: filename,
                type: fileType,
                uploadedAt: kstTime.toISOString()
            };
            
            if (!window.uploadedFiles) {
                window.uploadedFiles = [];
            }
            window.uploadedFiles.push(fileInfo);
            
            console.log('💾 File info saved:', fileInfo);
            console.log('🔍 Checking editor availability...');
            console.log('window.editor:', window.editor);
            console.log('window.editor?.insertImage:', window.editor?.insertImage);
            console.log('window.editor?.insertVideo:', window.editor?.insertVideo);
            
            let contentHtml = '';
            
            if (fileType === 'image') {
                // Google Drive URL을 직접 접근 가능한 형태로 변환
                let imageUrl = url;
                const fileIdMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (fileIdMatch) {
                    const fileId = fileIdMatch[1];
                    imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                    console.log('🔄 Converted image URL:', imageUrl);
                }
                
                // 직접 HTML 생성 (안전한 대안)
                contentHtml = `<div class="media-wrapper"><img class="media-image" src="${imageUrl}" alt="${filename}" loading="lazy"></div>`;
                
                // editor.js 함수도 시도
                if (window.editor && window.editor.insertImage) {
                    console.log('✅ Using editor.insertImage');
                    placeholder.remove();
                    window.editor.insertImage(imageUrl);
                    return;
                }
                
            } else if (fileType === 'video') {
                // Google Drive video URL 처리
                const fileIdMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (fileIdMatch) {
                    const fileId = fileIdMatch[1];
                    contentHtml = `<div class="media-wrapper"><iframe src="https://drive.google.com/file/d/${fileId}/preview" width="100%" height="400" class="media-video"></iframe></div>`;
                } else {
                    contentHtml = `<div class="media-wrapper"><video controls class="media-video"><source src="${url}" type="video/mp4">브라우저에서 비디오를 지원하지 않습니다.</video></div>`;
                }
                
                // editor.js 함수도 시도
                if (window.editor && window.editor.insertVideo) {
                    console.log('✅ Using editor.insertVideo');
                    placeholder.remove();
                    window.editor.insertVideo(url);
                    return;
                }
            }
            
            // 대안: 직접 HTML 교체
            console.log('⚠️ Editor not available, using direct HTML replacement');
            console.log('📄 Generated HTML:', contentHtml);
            
            if (contentHtml) {
                placeholder.outerHTML = contentHtml;
                console.log('✅ Direct HTML replacement completed');
            } else {
                console.error('❌ No content HTML generated');
                placeholder.remove();
            }
        }

        // 로딩 스피너 제거 (에러 시)
        function removeUploadPlaceholder(placeholderId) {
            const placeholder = document.getElementById(placeholderId);
            if (placeholder) {
                placeholder.remove();
            }
        }

        // editor.js 함수를 사용한 파일 삽입 (중복 제거)
        function insertUploadedFile(url, filename, fileType) {
            console.log('🔍 Using editor.js functions for file insertion...');
            
            // 파일 정보 저장 (한국 시간대)
            const fileInfo = {
                url: url,
                filename: filename,
                type: fileType,
                uploadedAt: getKSTTime().toISOString()
            };
            
            if (!window.uploadedFiles) {
                window.uploadedFiles = [];
            }
            window.uploadedFiles.push(fileInfo);
            
            // editor.js의 함수 사용
            if (window.editor) {
                if (fileType === 'image') {
                    // Google Drive URL을 직접 접근 가능한 형태로 변환
                    let imageUrl = url;
                    const fileIdMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                    if (fileIdMatch) {
                        const fileId = fileIdMatch[1];
                        imageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                    }
                    window.editor.insertImage(imageUrl);
                } else if (fileType === 'video') {
                    window.editor.insertVideo(url);
                }
                showToast(`${fileType === 'image' ? '이미지' : '동영상'}가 삽입되었습니다!`, 'success');
            } else {
                console.error('❌ Editor not available');
                showToast('에디터를 사용할 수 없습니다', 'error');
            }
        }

        function getMimeType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const mimeTypes = {
                // 동영상
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'ogg': 'video/ogg',
                'ogv': 'video/ogg',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'qt': 'video/quicktime',
                'wmv': 'video/x-ms-wmv',
                'flv': 'video/x-flv',
                'mkv': 'video/x-matroska',
                'm4v': 'video/mp4',
                '3gp': 'video/3gpp',
                '3g2': 'video/3gpp2',
                // 이미지
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'webp': 'image/webp',
                'svg': 'image/svg+xml',
                'bmp': 'image/bmp',
                // 오디오
                'mp3': 'audio/mpeg',
                'wav': 'audio/wav',
                'oga': 'audio/ogg',
                'm4a': 'audio/mp4',
                'aac': 'audio/aac'
            };
            
            const mimeType = mimeTypes[ext] || 'video/mp4';
            console.log(`🔍 File: ${filename} → Extension: ${ext} → MIME: ${mimeType}`);
            return mimeType;
        }

        // Drag and Drop functionality
        function initializeDragAndDrop() {
            const editor = document.getElementById('editor');
            
            // Drag over
            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.add('drag-over');
                editor.style.backgroundColor = 'rgba(74, 185, 255, 0.1)';
                editor.style.borderColor = '#4ab9ff';
            });
            
            // Drag leave
            editor.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.remove('drag-over');
                editor.style.backgroundColor = '';
                editor.style.borderColor = '';
            });
            
            // Drop
            editor.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editor.classList.remove('drag-over');
                editor.style.backgroundColor = '';
                editor.style.borderColor = '';
                
                const files = Array.from(e.dataTransfer.files);
                console.log('📎 Files dropped:', files.length);
                
                // 인증 확인
                if (!window.driveUploader || !window.driveUploader.isAuthenticated) {
                    showToast('먼저 Google Drive 인증을 완료해주세요 (🔐 버튼 클릭)', 'error');
                    return;
                }
                
                files.forEach(file => {
                    console.log('📄 Processing file:', file.name, file.type);
                    
                    if (file.type.startsWith('image/')) {
                        handleFileUpload([file], 'image');
                    } else if (file.type.startsWith('video/')) {
                        handleFileUpload([file], 'video');
                    } else {
                        showToast(`지원하지 않는 파일 형식입니다: ${file.name}`, 'error');
                    }
                });
            });
        }

        // Simple toast notification function
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 4px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // Initialize drag and drop when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // 페이지 로드 시 즉시 관리자 인증 확인
            if (!checkAdminAuth()) {
                return; // 인증 실패 시 초기화 중단
            }
            
            initializeDragAndDrop();
            
            // 에디터 클릭 차단 (업로드 중)
            const editorElement = document.getElementById('editor');
            if (editorElement) {
                editorElement.addEventListener('mousedown', (e) => {
                    if (isUploadInProgress) {
                        console.log('🚫 Upload in progress - preventing cursor movement');
                        e.preventDefault();
                        e.stopPropagation();
                        showToast('파일 업로드 중입니다. 잠시만 기다려주세요.', 'info');
                        return false;
                    }
                });
                
                editorElement.addEventListener('click', (e) => {
                    if (isUploadInProgress) {
                        console.log('🚫 Upload in progress - preventing cursor movement');
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                });
            }
            
            // Config 로딩 완료 이벤트 리스너 등록
            window.addEventListener('configLoaded', async () => {
                console.log('📋 Config loaded, initializing DriveUploader...');
                // Initialize DriveUploader with auto-login
                await initializeDriveUploader();
            });
            
            // 이미 config가 로드된 경우 즉시 초기화
            if (CONFIG.GOOGLE_CLIENT_ID) {
                console.log('📋 Config already loaded, initializing DriveUploader...');
                await initializeDriveUploader();
            }
            
            // Editor 초기화 대기 및 확인
            setTimeout(() => {
                console.log('🔍 Editor initialization check:');
                console.log('window.editor:', window.editor);
                console.log('window.RichTextEditor:', window.RichTextEditor);
                console.log('document.getElementById("editor"):', document.getElementById('editor'));
                
                if (!window.editor) {
                    console.warn('⚠️ Editor not initialized, attempting manual initialization...');
                    if (window.RichTextEditor) {
                        try {
                            window.editor = new window.RichTextEditor('editor');
                            console.log('✅ Manual editor initialization successful');
                        } catch (error) {
                            console.error('❌ Manual editor initialization failed:', error);
                        }
                    }
                }
                
                // 인증 상태 확인
                if (window.driveUploader) {
                    updateAuthButton(window.driveUploader.isAuthenticated);
                }
            }, 1500);
        });
    </script>

    <!-- Hidden File Input Elements -->
    <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="setTimeout(() => handleFileUpload(this.files, 'image'), 100)">
    <input type="file" id="videoFileInput" accept="video/*" style="display: none;" onchange="setTimeout(() => handleFileUpload(this.files, 'video'), 100)">
</body>
</html>