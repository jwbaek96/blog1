name: Update Blog Data

# ì‹¤í–‰ ì¡°ê±´
on:
  # 1ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰ (í¼ë¸”ë¦­ ë ˆí¬ì´ë¯€ë¡œ ë¬´ë£Œ)
  schedule:
    - cron: '1 * * * *'  # 1ì‹œê°„ë§ˆë‹¤
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes'
        required: false
        default: 'false'
        type: boolean

  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë„ ì‹¤í–‰
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: write  # íŒŒì¼ ìˆ˜ì • ê¶Œí•œ
  pages: write     # GitHub Pages ë°°í¬ ê¶Œí•œ
  id-token: write  # GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ í† í° ê¶Œí•œ

# ì‘ì—… ì •ì˜
jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # cache ì œê±° - package.jsonì´ ì—†ìœ¼ë¯€ë¡œ ìºì‹± ë¹„í™œì„±í™”

      # 3. ì˜ì¡´ì„± í™•ì¸ (í•„ìš”í•œ ê²½ìš°)
      - name: ğŸ“¦ Check dependencies
        run: |
          # ê¸°ë³¸ Node.js ëª¨ë“ˆë“¤ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ë³„ë„ ì„¤ì¹˜ ë¶ˆí•„ìš”
          # í•˜ì§€ë§Œ fetch APIë¥¼ ìœ„í•´ Node.js 18 ì´ìƒ í•„ìš”
          echo "âœ… Using Node.js $(node --version)"
          echo "âœ… Using built-in fetch API and fs modules"

      # 4. Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì™€ì„œ JSON íŒŒì¼ ìƒì„±
      - name: ğŸ”„ Update data from Google Sheets
        env:
          GOOGLE_APPS_SCRIPT_URL: ${{ secrets.GOOGLE_APPS_SCRIPT_URL }}
        run: |
          echo "ğŸš€ Starting data update process..."
          node scripts/update-data.js
          echo "âœ… Data update completed"

      # 5. ë³€ê²½ì‚¬í•­ í™•ì¸
      - name: ğŸ“Š Check for changes
        id: changes
        run: |
          # Git ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --quiet HEAD -- data/; then
            echo "No changes detected in data files"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in data files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # ë³€ê²½ëœ íŒŒì¼ë“¤ ë³´ê¸°
            echo "Changed files:"
            git diff --name-only HEAD -- data/
            
            # ë³€ê²½ì‚¬í•­ ìš”ì•½
            echo "Changes summary:"
            git diff --stat HEAD -- data/
          fi

      # 6. ë³€ê²½ì‚¬í•­ì´ ìˆê±°ë‚˜ ê°•ì œ ì—…ë°ì´íŠ¸ì¸ ê²½ìš° ì»¤ë°‹
      - name: ğŸ’¾ Commit and push changes
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
        run: |
          # Git ì‚¬ìš©ì ì„¤ì •
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
          git add data/
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          commit_message="ğŸ”„ Auto-update blog data $(date +'%Y-%m-%d %H:%M:%S UTC')"
          
          # íŒŒì¼ë³„ ë³€ê²½ì‚¬í•­ ìš”ì•½ ì¶”ê°€
          if [ -f data/posts.json ]; then
            posts_count=$(jq '.count // 0' data/posts.json)
            commit_message="$commit_message\n\nğŸ“ Posts: $posts_count"
          fi
          
          if [ -f data/artworks.json ]; then
            artworks_count=$(jq '.count // 0' data/artworks.json)
            commit_message="$commit_message\nğŸ¨ Artworks: $artworks_count"
          fi
          
          if [ -f data/projects.json ]; then
            projects_count=$(jq '.count // 0' data/projects.json)
            commit_message="$commit_message\nğŸš€ Projects: $projects_count"
          fi
          
          # ì»¤ë°‹ ì‹¤í–‰
          git commit -m "$commit_message"
          
          # í‘¸ì‹œ ì‹¤í–‰
          git push
          
          echo "âœ… Changes committed and pushed successfully"

      # 7. ê²°ê³¼ ìš”ì•½ ì¶œë ¥
      - name: ğŸ“‹ Summary
        run: |
          echo "## ğŸ“Š Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Data updated successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ˆ Current counts:" >> $GITHUB_STEP_SUMMARY
            
            if [ -f data/posts.json ]; then
              posts_count=$(jq '.count // 0' data/posts.json)
              echo "- ğŸ“ Posts: $posts_count" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f data/artworks.json ]; then
              artworks_count=$(jq '.count // 0' data/artworks.json)
              echo "- ğŸ¨ Artworks: $artworks_count" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f data/projects.json ]; then
              projects_count=$(jq '.count // 0' data/projects.json)
              echo "- ğŸš€ Projects: $projects_count" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ•’ Last updated:" >> $GITHUB_STEP_SUMMARY
            echo "$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Data is already up to date." >> $GITHUB_STEP_SUMMARY
          fi

  # GitHub Pages ë°°í¬ (ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ëœ ê²½ìš°ì—ë§Œ)
  deploy-pages:
    needs: update-data
    runs-on: ubuntu-latest
    if: always() && (needs.update-data.result == 'success')
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (ìµœì‹  ë°ì´í„° í¬í•¨)
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # ìµœì‹  main ë¸Œëœì¹˜ ì‚¬ìš©

      # 2. GitHub Pages ì•„í‹°íŒ©íŠ¸ ìƒì„±
      - name: ğŸ“¦ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ—ï¸ Build site
        run: |
          # í•„ìš”í•œ ê²½ìš° ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          echo "Building site for GitHub Pages..."
          
          # ì •ì  íŒŒì¼ë“¤ì´ ì´ë¯¸ ì¤€ë¹„ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ë¹Œë“œ ë¶ˆí•„ìš”
          echo "âœ… Site ready for deployment"

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      # 3. GitHub Pagesì— ë°°í¬
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4