<!DOCTYPE html>
<html>
<head>
    <title>Google API 최소 테스트</title>
</head>
<body>
    <h1>Google API 초기화 테스트</h1>
    <div id="status">준비됨 - 테스트를 선택하세요</div>
    
    <div style="margin: 20px 0;">
        <h3>인증 테스트:</h3>
        <button onclick="testOldWay()" style="margin: 5px; padding: 10px;">1. 기존 방식 (gapi.auth2)</button><br>
        <button onclick="testNewWay()" style="margin: 5px; padding: 10px;">2. 새로운 방식 (Google Identity Services) ✅</button><br>
        <button onclick="testInit()" style="margin: 5px; padding: 10px;">3. 둘 다 테스트</button>
    </div>
    
    <div style="margin: 20px 0; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px; background: #f0f8f0;">
        <h3>🎉 인증 성공! 이제 파일 업로드 테스트를 해보세요:</h3>
        <input type="file" id="fileInput" accept="image/*,video/*" style="margin: 10px 0;">
        <button onclick="uploadFile()" style="margin: 5px; padding: 10px; background: #4CAF50; color: white;">파일 업로드 테스트</button>
        <div id="uploadStatus" style="margin: 10px 0; font-weight: bold;"></div>
    </div>
    
    <!-- Google Identity Services 새로운 방식 -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = '201175895307-8au0ct74b8d78mlae58mdm7noddabjvm.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAY4DHjJkDmVklkxXT3TXtorayCd3XPccI';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let accessToken = null;
        
        // Google Identity Services 초기화
        function initializeGIS() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    console.log('✅ 토큰 획득 성공:', tokenResponse);
                    document.getElementById('status').innerHTML = '✅ 인증 성공! 토큰 획득됨';
                },
            });
            console.log('✅ Google Identity Services 초기화 완료');
        }
        
        // 기존 방식 (gapi.auth2) 테스트
        function testOldWay() {
            document.getElementById('status').innerHTML = '⏳ 기존 방식 테스트 중...';
            
            gapi.load('client:auth2', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        clientId: CLIENT_ID,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                        scope: SCOPES
                    });
                    
                    document.getElementById('status').innerHTML = '✅ 기존 방식 성공!';
                    console.log('✅ 기존 방식 성공');
                    
                } catch (error) {
                    document.getElementById('status').innerHTML = `❌ 기존 방식 실패: ${error.error}`;
                    console.error('❌ 기존 방식 실패:', error);
                }
            });
        }
        
        // 새로운 방식 (Google Identity Services) 테스트
        function testNewWay() {
            document.getElementById('status').innerHTML = '⏳ 새로운 방식 테스트 중...';
            
            // Google API 클라이언트만 초기화 (인증 없이)
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                    
                    console.log('✅ API 클라이언트 초기화 성공');
                    
                    // 토큰 요청
                    if (tokenClient) {
                        tokenClient.requestAccessToken();
                    } else {
                        document.getElementById('status').innerHTML = '❌ 토큰 클라이언트가 초기화되지 않음';
                    }
                    
                } catch (error) {
                    document.getElementById('status').innerHTML = `❌ 새로운 방식 실패: ${error.message}`;
                    console.error('❌ 새로운 방식 실패:', error);
                }
            });
        }
        
        // 통합 테스트 함수
        function testInit() {
            console.log('🌐 현재 Origin:', window.location.origin);
            console.log('🔑 Client ID:', CLIENT_ID);
            
            // 둘 다 시도
            console.log('📋 1. 기존 방식 시도...');
            setTimeout(() => {
                console.log('📋 2. 새로운 방식 시도...');
                testNewWay();
            }, 3000);
            
            testOldWay();
        }
        
        // 파일 업로드 테스트
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const uploadStatus = document.getElementById('uploadStatus');
            const file = fileInput.files[0];
            
            if (!file) {
                uploadStatus.innerHTML = '❌ 파일을 선택해주세요';
                return;
            }
            
            if (!accessToken) {
                uploadStatus.innerHTML = '❌ 먼저 인증을 완료해주세요 (새로운 방식 버튼 클릭)';
                return;
            }
            
            uploadStatus.innerHTML = '⏳ 업로드 중...';
            
            try {
                console.log('📤 파일 업로드 시작:', file.name);
                
                // Google Drive API를 사용한 파일 업로드
                const metadata = {
                    'name': file.name,
                    'parents': ['1gei84cTcsgRheWIyhGuqPLX4DZcXTJkb'] // Blog Data 폴더 ID
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                form.append('file', file);
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: form
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ 업로드 성공:', result);
                
                // 파일을 공개로 설정
                await makeFilePublic(result.id);
                
                const publicUrl = `https://drive.google.com/uc?id=${result.id}`;
                
                uploadStatus.innerHTML = `
                    ✅ 업로드 성공!<br>
                    <small>파일명: ${result.name}</small><br>
                    <small>ID: ${result.id}</small><br>
                    <small><a href="${publicUrl}" target="_blank">공개 URL</a></small>
                `;
                
            } catch (error) {
                console.error('❌ 업로드 실패:', error);
                uploadStatus.innerHTML = `❌ 업로드 실패: ${error.message}`;
            }
        }
        
        // 파일을 공개로 설정
        async function makeFilePublic(fileId) {
            try {
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'role': 'reader',
                        'type': 'anyone'
                    })
                });
                console.log('✅ 파일 공개 설정 완료');
            } catch (error) {
                console.warn('⚠️ 파일 공개 설정 실패:', error);
            }
        }
        
        // 페이지 로드시 GIS 초기화
        window.onload = () => {
            initializeGIS();
        };
        
        // 페이지 로드시 현재 URL 표시
        document.addEventListener('DOMContentLoaded', () => {
            console.log('현재 URL:', window.location.href);
            console.log('현재 Origin:', window.location.origin);
        });
    </script>
</body>
</html>